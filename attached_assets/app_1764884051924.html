<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Purchase Order Register</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --field-height: 3.25rem;
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { border-radius: 9999px; }

    /* Base fields */
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      background-color: #e0f2fe;
      font-size: 1.25rem;
      height: var(--field-height);
      padding: 0.5rem 0.75rem;
      box-sizing: border-box;
    }

    #supplierSelect {
      font-size: 1.5rem;
    }

    /* File inputs – pill-shaped, tall */
    input[type="file"] {
      background-color: #e0f2fe;
      font-size: 1rem;
      height: var(--field-height);
      padding: 0 0.75rem;
      border-radius: 9999px;
      box-sizing: border-box;
      border: 1px solid #bfdbfe;
    }
    /* Browse button LEFT side inside field */
    input[type="file"]::-webkit-file-upload-button,
    input[type="file"]::file-selector-button {
      height: calc(var(--field-height) - 0.5rem);
      padding: 0 1.5rem;
      border-radius: 9999px;
      display: inline-block;
      margin: 0;
    }

    @media print {
      .no-print {
        display: none !important;
      }
      body {
        background: #ffffff;
      }
    }
  </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-900">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- HEADER -->
    <header class="no-print flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight">
          Iqbal Electronics Co. WLL
        </h1>
        <p class="text-sm text-slate-500">
          Purchase Order Register
        </p>
      </div>
      <div class="flex items-center gap-2 text-xs text-slate-500">
        <span class="px-2 py-1 rounded-full bg-white shadow">
          Storage: Browser (local)
        </span>
        <span class="px-2 py-1 rounded-full bg-white shadow">
          Formats: PDF / JPG / PNG
        </span>
      </div>
    </header>

    <!-- NEW PURCHASE ENTRY -->
    <section class="no-print mb-6">
      <div class="bg-white shadow-sm rounded-2xl p-4 md:p-6 space-y-4">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-lg font-semibold">New Purchase Entry</h2>
          <button id="resetFormBtn"
                  class="text-xs px-2 py-1 rounded-full border border-slate-200 hover:bg-slate-50">
            Reset form
          </button>
        </div>

        <form id="poForm" class="space-y-4">
          <!-- Date + Invoice No -->
          <div class="grid md:grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Purchase Date</label>
              <input type="date" id="poDate" required
                     class="w-full rounded-xl border-slate-200 text-sm px-3 focus:outline-none focus:ring-2 focus:ring-sky-500/60" />
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Invoice Number</label>
              <input type="text" id="invoiceNumber" placeholder="e.g. INV-2025-001"
                     class="w-full rounded-xl border-slate-200 text-sm px-3 focus:outline-none focus:ring-2 focus:ring-sky-500/60" />
            </div>
          </div>

          <!-- Supplier -->
          <div>
            <label class="block text-xs font-medium text-slate-600 mb-1">Supplier</label>
            <div class="flex gap-2 flex-wrap">
              <select id="supplierSelect"
                      class="flex-1 rounded-xl border-slate-200 text-lg px-2 focus:outline-none focus:ring-2 focus:ring-sky-500/60 min-w-[180px]">
                <option value="">-- Select supplier --</option>
              </select>
              <button type="button" id="addSupplierBtn"
                      class="text-xs px-3 py-2 rounded-xl bg-emerald-500 text-white hover:bg-emerald-600 whitespace-nowrap">
                + Supplier
              </button>
              <button type="button" id="editSupplierBtn"
                      class="text-xs px-3 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600 whitespace-nowrap">
                Edit
              </button>
            </div>
          </div>

          <!-- ITEMS (MULTIPLE LINES PER INVOICE) -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <!-- removed: "Items for this invoice" text -->
              <div class="flex gap-2 ml-auto">
                <button type="button" id="addItemMasterBtn"
                        class="text-[11px] px-3 py-1.5 rounded-xl bg-emerald-500 text-white hover:bg-emerald-600">
                  + Item master
                </button>
                <button type="button" id="editItemMasterBtn"
                        class="text-[11px] px-3 py-1.5 rounded-xl bg-amber-500 text-white hover:bg-amber-600">
                  Edit item
                </button>
              </div>
            </div>
            <div class="border border-slate-200 rounded-2xl overflow-x-auto">
              <table class="min-w-full text-xs">
                <thead class="bg-slate-50">
                  <tr class="text-[11px] text-slate-500">
                    <th class="px-3 py-2 text-left w-1/2 min-w-[260px]">Item</th>
                    <th class="px-1 py-2 text-center w-[8%]">Qty</th>
                    <th class="px-1 py-2 text-center w-[12%]">Price KWD</th>
                    <th class="px-1 py-2 text-center w-[15%]">FX Price</th>
                    <th class="px-1 py-2 text-center w-[15%]">Total</th>
                    <th class="px-3 py-2 text-center w-[10%]">Remove</th>
                  </tr>
                </thead>
                <tbody id="itemsBody" class="bg-white">
                  <!-- rows via JS -->
                </tbody>
              </table>
            </div>
            <div class="mt-2">
              <button type="button" id="addRowBtn"
                      class="text-[11px] px-3 py-1.5 rounded-xl border border-slate-300 hover:bg-slate-50">
                + Add item row
              </button>
            </div>
          </div>

          <!-- Prices & Totals -->
          <div class="grid md:grid-cols-2 gap-3">
            <!-- KWD side -->
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">Total Amount (KWD)</label>
              <input type="number" step="0.001" min="0" id="totalKwd"
                     placeholder="Auto: sum of item lines"
                     readonly
                     class="w-full rounded-xl border-slate-200 text-sm px-3 focus:outline-none" />
            </div>

            <!-- FX side -->
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">
                Currency (toggle) &amp; Conversion Rate
              </label>
              <div class="flex items-center gap-2 mb-2">
                <div class="inline-flex rounded-full border border-slate-200 bg-slate-50 p-0.5 text-xs">
                  <button type="button" data-currency-toggle="AED"
                          class="px-3 py-1.5 rounded-full toggle-active">
                    AED
                  </button>
                  <button type="button" data-currency-toggle="USD"
                          class="px-3 py-1.5 rounded-full">
                    USD
                  </button>
                </div>
                <input type="number" step="0.0001" min="0" id="fxRate"
                       placeholder="Rate per 1 KWD (e.g. 11.95)"
                       class="flex-1 rounded-xl border-slate-200 text-sm px-3 focus:outline-none focus:ring-2 focus:ring-sky-500/60" />
              </div>
              <input type="hidden" id="fxCurrency" value="AED" />

              <label class="block text-xs font-medium text-slate-600 mb-1">Total Amount (AED / USD)</label>
              <input type="number" step="0.01" min="0" id="totalFx"
                     placeholder="Auto: Total KWD × Rate"
                     readonly
                     class="w-full rounded-xl border-slate-200 text-sm px-3 focus:outline-none" />
            </div>
          </div>

          <!-- Files -->
          <div class="grid md:grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">
                Invoice
              </label>
              <input type="file" id="invoiceFile" accept=".pdf,.jpg,.jpeg,.png"
                     class="w-full text-xs file:mr-2 file:px-4 file:py-2 file:rounded-full file:border-none file:bg-sky-500 file:text-white file:text-xs file:cursor-pointer" />
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">
                Delivery Note
              </label>
              <input type="file" id="doFile" accept=".pdf,.jpg,.jpeg,.png"
                     class="w-full text-xs file:mr-2 file:px-4 file:py-2 file:rounded-full file:border-none file:bg-sky-500 file:text-white file:text-xs file:cursor-pointer" />
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-3">
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">
                TT Copy
              </label>
              <input type="file" id="ttFile" accept=".pdf,.jpg,.jpeg,.png"
                     class="w-full text-xs file:mr-2 file:px-4 file:py-2 file:rounded-full file:border-none file:bg-sky-500 file:text-white file:text-xs file:cursor-pointer" />
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-600 mb-1">
                Goods Arrived in Kuwait
              </label>
              <input type="date" id="grnDate"
                     class="w-full rounded-xl border-slate-200 text-sm px-3 focus:outline-none focus:ring-2 focus:ring-sky-500/60" />
            </div>
          </div>

          <div class="flex items-center justify-between gap-3 pt-2">
            <p class="text-[11px] text-slate-400">
              Note: Very large files may not save due to browser storage limits.
            </p>
            <button type="submit"
                    class="inline-flex items-center justify-center gap-2 rounded-xl bg-sky-600 text-white text-sm font-medium px-4 py-2 shadow-sm hover:bg-sky-700 active:scale-[0.99]">
              <span>Save Record</span>
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- REPORTING & ARCHIVE -->
    <section>
      <div class="bg-white shadow-sm rounded-2xl p-4 md:p-6 space-y-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold">Reporting & Archive</h2>
            <p class="text-xs text-slate-500">
              Filter by date / month / year and review totals and documents.
            </p>
          </div>
          <div class="no-print flex flex-col md:flex-row gap-2 text-xs items-start md:items-center">
            <div class="flex flex-wrap gap-2">
              <select id="filterYear"
                      class="rounded-xl border-slate-200 px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-sky-500/60">
                <option value="all">Year: All</option>
              </select>
              <select id="filterMonth"
                      class="rounded-xl border-slate-200 px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-sky-500/60">
                <option value="all">Month: All</option>
                <option value="1">Jan</option>
                <option value="2">Feb</option>
                <option value="3">Mar</option>
                <option value="4">Apr</option>
                <option value="5">May</option>
                <option value="6">Jun</option>
                <option value="7">Jul</option>
                <option value="8">Aug</option>
                <option value="9">Sep</option>
                <option value="10">Oct</option>
                <option value="11">Nov</option>
                <option value="12">Dec</option>
              </select>
              <input type="date" id="filterDateExact"
                     class="rounded-xl border-slate-200 px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-sky-500/60"
                     placeholder="Exact date" />
              <label class="inline-flex items-center gap-1 text-[11px] text-slate-600">
                <input type="checkbox" id="filterDocsOnly" />
                <span>Docs only</span>
              </label>
            </div>
            <div class="flex gap-2">
              <button id="clearFiltersBtn"
                      class="rounded-xl border border-slate-200 px-3 py-1.5 hover:bg-slate-50">
                Clear Filters
              </button>
              <button id="printBtn"
                      class="rounded-xl bg-slate-800 text-white px-3 py-1.5 hover:bg-slate-900">
                Print filtered records
              </button>
            </div>
          </div>
        </div>

        <!-- KPI ROW -->
        <div class="grid sm:grid-cols-3 gap-3 text-sm">
          <div class="bg-slate-50 rounded-2xl px-3 py-3">
            <p class="text-[11px] text-slate-500 mb-1">Records (Filtered)</p>
            <p class="text-lg font-semibold" id="kpiCount">0</p>
          </div>
          <div class="bg-slate-50 rounded-2xl px-3 py-3">
            <p class="text-[11px] text-slate-500 mb-1">Total KWD (Filtered)</p>
            <p class="text-lg font-semibold" id="kpiKwd">0.000</p>
          </div>
          <div class="bg-slate-50 rounded-2xl px-3 py-3">
            <p class="text-[11px] text-slate-500 mb-1">Total FX (Filtered)</p>
            <p class="text-lg font-semibold" id="kpiFx">0.00</p>
          </div>
        </div>

        <!-- MONTHLY GRAPH -->
        <div class="bg-slate-50 rounded-2xl px-3 py-3">
          <p class="text-[11px] text-slate-500 mb-1">
            Monthly Purchases (KWD &amp; FX) – grouped by month (year filter applied)
          </p>
          <div style="height: 220px;">
            <canvas id="monthlyChart"></canvas>
          </div>
        </div>

        <!-- TABLE -->
        <div class="border border-slate-100 rounded-2xl overflow-hidden">
          <div class="overflow-x-auto max-h-[420px]">
            <table class="min-w-full text-xs">
              <thead class="bg-slate-50/70 sticky top-0 z-10">
                <tr class="text-[11px] text-slate-500">
                  <th class="px-3 py-2 text-left">Date</th>
                  <th class="px-3 py-2 text-left">Invoice #</th>
                  <th class="px-3 py-2 text-left">Supplier</th>
                  <th class="px-3 py-2 text-left">Items</th>
                  <th class="px-3 py-2 text-right">Total KWD</th>
                  <th class="px-3 py-2 text-right">FX Rate</th>
                  <th class="px-3 py-2 text-right">Total FX</th>
                  <th class="px-3 py-2 text-center">Docs</th>
                  <th class="px-3 py-2 text-center">GRN Date</th>
                  <th class="px-3 py-2 text-center no-print">View</th>
                </tr>
              </thead>
              <tbody id="poTableBody" class="divide-y divide-slate-100 bg-white">
                <!-- rows -->
              </tbody>
            </table>
          </div>
          <div id="emptyState" class="p-4 text-center text-xs text-slate-400">
            No purchase orders captured yet.
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- DETAIL MODAL -->
  <div id="detailModal"
       class="no-print hidden fixed inset-0 bg-slate-900/40 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between border-b px-4 py-3">
        <h3 class="text-sm font-semibold">Purchase Order Details</h3>
        <button id="closeModalBtn"
                class="text-slate-400 hover:text-slate-600 text-lg leading-none">
          ×
        </button>
      </div>
      <div class="p-4 space-y-3 text-xs">
        <dl class="space-y-2" id="detailContent">
          <!-- injected -->
        </dl>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "purchaseOrdersV2_multiItems";
    const SUPPLIERS_KEY = "poSuppliersV1";
    const ITEMS_KEY = "poItemsV2";

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch {
        return fallback;
      }
    }
    function saveJSON(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function loadPOs() { return loadJSON(STORAGE_KEY, []); }
    function savePOs(list) { saveJSON(STORAGE_KEY, list); }
    function loadSuppliers() { return loadJSON(SUPPLIERS_KEY, []); }
    function saveSuppliers(list) { saveJSON(SUPPLIERS_KEY, list); }
    function loadItems() { return loadJSON(ITEMS_KEY, []); }
    function saveItems(list) { saveJSON(ITEMS_KEY, list); }

    function readFileAsDataUrl(file) {
      return new Promise((resolve) => {
        if (!file) return resolve(null);
        const maxBytes = 1.5 * 1024 * 1024;
        if (file.size > maxBytes) {
          alert(file.name + " is large; it will NOT be stored. Keep files below ~1.5 MB.");
          return resolve(null);
        }
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => resolve(null);
        reader.readAsDataURL(file);
      });
    }

    function formatNumber(num, decimals) {
      if (num === null || num === undefined || num === "") return "";
      const n = Number(num);
      if (isNaN(n)) return "";
      return n.toFixed(decimals);
    }

    function getYearFromDateStr(str) {
      if (!str) return null;
      const d = new Date(str);
      return isNaN(d.getTime()) ? null : d.getFullYear();
    }

    function getMonthFromDateStr(str) {
      if (!str) return null;
      const d = new Date(str);
      return isNaN(d.getTime()) ? null : d.getMonth() + 1;
    }

    const poForm = document.getElementById("poForm");
    const resetFormBtn = document.getElementById("resetFormBtn");
    const poDate = document.getElementById("poDate");
    const invoiceNumberInput = document.getElementById("invoiceNumber");

    const supplierSelect = document.getElementById("supplierSelect");
    const addSupplierBtn = document.getElementById("addSupplierBtn");
    const editSupplierBtn = document.getElementById("editSupplierBtn");

    const itemsBody = document.getElementById("itemsBody");
    const addRowBtn = document.getElementById("addRowBtn");
    const addItemMasterBtn = document.getElementById("addItemMasterBtn");
    const editItemMasterBtn = document.getElementById("editItemMasterBtn");

    const fxRate = document.getElementById("fxRate");
    const fxCurrencyInput = document.getElementById("fxCurrency");
    const totalKwd = document.getElementById("totalKwd");
    const totalFx = document.getElementById("totalFx");

    const invoiceFile = document.getElementById("invoiceFile");
    const doFile = document.getElementById("doFile");
    const ttFile = document.getElementById("ttFile");
    const grnDate = document.getElementById("grnDate");

    const filterYear = document.getElementById("filterYear");
    const filterMonth = document.getElementById("filterMonth");
    const filterDateExact = document.getElementById("filterDateExact");
    const filterDocsOnly = document.getElementById("filterDocsOnly");
    const clearFiltersBtn = document.getElementById("clearFiltersBtn");
    const printBtn = document.getElementById("printBtn");
    const poTableBody = document.getElementById("poTableBody");
    const emptyState = document.getElementById("emptyState");

    const kpiCount = document.getElementById("kpiCount");
    const kpiKwd = document.getElementById("kpiKwd");
    const kpiFx = document.getElementById("kpiFx");

    const detailModal = document.getElementById("detailModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const detailContent = document.getElementById("detailContent");

    const monthlyChartCanvas = document.getElementById("monthlyChart");
    let monthlyChartInstance = null;

    let poData = [];
    let supplierData = [];
    let itemData = [];

    function populateItemSelectOptions(select, selectedValue = "") {
      const current = selectedValue || select.value;
      select.innerHTML = '<option value="">-- Select item --</option>';
      itemData.slice().sort((a,b)=>a.localeCompare(b)).forEach((name)=>{
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
      if (current && itemData.includes(current)) {
        select.value = current;
      }
    }

    function populateAllItemSelects() {
      document.querySelectorAll(".item-name").forEach((sel)=>{
        populateItemSelectOptions(sel);
      });
    }

    function addItemRow(prefill) {
      const tr = document.createElement("tr");
      tr.className = "border-t border-slate-100";
      tr.innerHTML = `
        <td class="px-3 py-1.5 w-1/2 min-w-[260px]">
          <select class="item-name w-full rounded-xl border-slate-200 text-sm px-2 focus:outline-none focus:ring-2 focus:ring-sky-500/60">
            <option value="">-- Select item --</option>
          </select>
        </td>
        <td class="px-1 py-1.5 text-center w-[8%]">
          <input type="number" min="0" step="1"
                 class="item-qty w-full rounded-xl border-slate-200 text-sm px-2 text-center focus:outline-none focus:ring-2 focus:ring-sky-500/60" />
        </td>
        <td class="px-1 py-1.5 text-center w-[12%]">
          <input type="number" min="0" step="0.001"
                 class="item-price w-full rounded-xl border-slate-200 text-sm px-2 text-center focus:outline-none focus:ring-2 focus:ring-sky-500/60" />
        </td>
        <td class="px-1 py-1.5 text-center w-[15%]">
          <input type="number" min="0" step="0.01"
                 class="item-fxprice w-full rounded-xl border-slate-200 text-sm px-2 text-center focus:outline-none focus:ring-2 focus:ring-sky-500/60" />
        </td>
        <td class="px-1 py-1.5 text-center w-[15%]">
          <input type="number" readonly
                 class="item-total w-full rounded-xl border-slate-200 text-sm px-2 text-center bg-slate-100" />
        </td>
        <td class="px-3 py-1.5 text-center w-[10%]">
          <button type="button" class="remove-row text-[11px] px-2 py-1 rounded-full bg-rose-50 text-rose-700 hover:bg-rose-100">
            ×
          </button>
        </td>
      `;
      const select = tr.querySelector(".item-name");
      const qtyInput = tr.querySelector(".item-qty");
      const priceInput = tr.querySelector(".item-price");
      const removeBtn = tr.querySelector(".remove-row");

      populateItemSelectOptions(select, prefill?.name || "");

      if (prefill) {
        qtyInput.value = prefill.qty ?? "";
        priceInput.value = prefill.priceKwd ?? "";
        const fxInput = tr.querySelector(".item-fxprice");
        if (prefill.fxPrice != null) {
          fxInput.value = prefill.fxPrice;
        }
      }

      qtyInput.addEventListener("input", recalcTotals);
      priceInput.addEventListener("input", recalcTotals);
      tr.querySelector(".item-fxprice").addEventListener("input", recalcTotals);
      removeBtn.addEventListener("click", () => {
        if (itemsBody.children.length > 1) {
          itemsBody.removeChild(tr);
          recalcTotals();
        } else {
          select.value = "";
          qtyInput.value = "";
          priceInput.value = "";
          tr.querySelector(".item-fxprice").value = "";
          tr.querySelector(".item-total").value = "";
          recalcTotals();
        }
      });

      itemsBody.appendChild(tr);
      recalcTotals();
    }

    function recalcTotals() {
      let invoiceTotalKwd = 0;
      itemsBody.querySelectorAll("tr").forEach((tr)=>{
        const qty = Number(tr.querySelector(".item-qty").value) || 0;
        const price = Number(tr.querySelector(".item-price").value) || 0;
        const lineTotal = qty * price;
        tr.querySelector(".item-total").value = lineTotal ? lineTotal.toFixed(3) : "";
        invoiceTotalKwd += lineTotal;
      });
      totalKwd.value = invoiceTotalKwd ? invoiceTotalKwd.toFixed(3) : "";

      const rateVal = Number(fxRate.value) || 0;
      const fxVal = invoiceTotalKwd * rateVal;
      totalFx.value = fxVal ? fxVal.toFixed(2) : "";
    }

    function renderSupplierOptions() {
      const currentVal = supplierSelect.value;
      supplierSelect.innerHTML = '<option value="">-- Select supplier --</option>';
      supplierData.slice().sort((a,b)=>a.localeCompare(b)).forEach((name)=>{
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        supplierSelect.appendChild(opt);
      });
      if (currentVal && supplierData.includes(currentVal)) {
        supplierSelect.value = currentVal;
      }
    }

    function refreshYearFilterOptions() {
      const years = Array.from(new Set(poData.map(po=>getYearFromDateStr(po.poDate)).filter(y=>y!==null))).sort((a,b)=>a-b);
      const currentVal = filterYear.value;
      filterYear.innerHTML = '<option value="all">Year: All</option>';
      years.forEach((y)=>{
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = y;
        filterYear.appendChild(opt);
      });
      if (currentVal && currentVal!=="all" && years.includes(Number(currentVal))) {
        filterYear.value = currentVal;
      }
    }

    function applyFilters(data) {
      const yearFilter = filterYear.value;
      const monthFilter = filterMonth.value;
      const exactDate = filterDateExact.value;
      const docsOnly = filterDocsOnly.checked;

      return data.filter((po)=>{
        const y = getYearFromDateStr(po.poDate);
        const m = getMonthFromDateStr(po.poDate);

        if (exactDate) {
          if (po.poDate !== exactDate) return false;
        } else {
          if (yearFilter !== "all" && y !== Number(yearFilter)) return false;
          if (monthFilter !== "all" && m !== Number(monthFilter)) return false;
        }

        if (docsOnly) {
          const hasDocs = !!po.invoiceFileName || !!po.doFileName || !!po.ttFileName;
          if (!hasDocs) return false;
        }
        return true;
      });
    }

    function getItemSummary(po) {
      if (po.items && po.items.length) {
        const first = po.items[0].name || "Item";
        if (po.items.length === 1) return first;
        return first + " +" + (po.items.length - 1) + " more";
      }
      return po.itemDesc || "";
    }

    function renderTable() {
      const filtered = applyFilters(poData);
      poTableBody.innerHTML = "";

      if (!filtered.length) emptyState.classList.remove("hidden");
      else emptyState.classList.add("hidden");

      let sumKwd = 0;
      let sumFx = 0;

      filtered.forEach((po, index)=>{
        const tr = document.createElement("tr");
        tr.className = index % 2 === 0 ? "bg-white" : "bg-slate-50/40";

        const docIcons = [];
        if (po.invoiceFileName) docIcons.push("INV");
        if (po.doFileName) docIcons.push("DO");
        if (po.ttFileName) docIcons.push("TT");

        sumKwd += Number(po.totalKwd || 0);
        sumFx += Number(po.totalFx || 0);

        const fxRateText =
          po.fxCurrency && po.fxRate
            ? `${po.fxCurrency} ${formatNumber(po.fxRate, 4)}`
            : "";

        tr.innerHTML = `
          <td class="px-3 py-2 align-top">${po.poDate || ""}</td>
          <td class="px-3 py-2 align-top">${po.invoiceNumber || ""}</td>
          <td class="px-3 py-2 align-top max-w-[140px] truncate" title="${po.supplierName || ""}">
            ${po.supplierName || ""}
          </td>
          <td class="px-3 py-2 align-top max-w-[220px] truncate" title="${getItemSummary(po)}">
            ${getItemSummary(po)}
          </td>
          <td class="px-3 py-2 align-top text-right">
            ${po.totalKwd ? formatNumber(po.totalKwd, 3) : ""}
          </td>
          <td class="px-3 py-2 align-top text-right">
            ${fxRateText}
          </td>
          <td class="px-3 py-2 align-top text-right">
            ${po.fxCurrency || ""} ${po.totalFx ? formatNumber(po.totalFx, 2) : ""}
          </td>
          <td class="px-3 py-2 align-top text-center text-[11px]">
            ${docIcons.length ? docIcons.join(" · ") : "-"}
          </td>
          <td class="px-3 py-2 align-top text-center">
            ${po.grnDate || "-"}
          </td>
          <td class="px-3 py-2 align-top text-center no-print">
            <button data-id="${po.id}"
                    class="viewBtn text-[11px] px-2 py-1 rounded-full bg-sky-50 text-sky-700 hover:bg-sky-100">
              View
            </button>
          </td>
        `;
        poTableBody.appendChild(tr);
      });

      kpiCount.textContent = filtered.length;
      kpiKwd.textContent = formatNumber(sumKwd, 3);
      kpiFx.textContent = formatNumber(sumFx, 2);

      document.querySelectorAll(".viewBtn").forEach((btn)=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-id");
          openDetailModal(id);
        });
      });

      renderMonthlyChart();
    }

    function openDetailModal(id) {
      const po = poData.find((p)=>p.id === id);
      if (!po) return;
      detailContent.innerHTML = "";

      function addRow(label, value, isHtml) {
        const dt = document.createElement("dt");
        dt.className = "text-[11px] font-medium text-slate-500";
        dt.textContent = label;

        const dd = document.createElement("dd");
        dd.className = "text-xs mb-2";
        if (isHtml) dd.innerHTML = value;
        else dd.textContent = value || "-";

        detailContent.appendChild(dt);
        detailContent.appendChild(dd);
      }

      addRow("Purchase Date", po.poDate);
      addRow("Invoice Number", po.invoiceNumber);
      addRow("Supplier Name", po.supplierName);

      if (po.items && po.items.length) {
        let html = `<table class="min-w-full text-[11px] border border-slate-200 rounded-lg overflow-hidden">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-2 py-1 text-left">Item</th>
              <th class="px-2 py-1 text-right">Qty</th>
              <th class="px-2 py-1 text-right">Price KWD</th>
              <th class="px-2 py-1 text-right">FX Price</th>
              <th class="px-2 py-1 text-right">Line KWD</th>
            </tr>
          </thead>
          <tbody>`;
        po.items.forEach((line)=>{
          html += `<tr>
            <td class="px-2 py-1">${line.name || ""}</td>
            <td class="px-2 py-1 text-right">${line.qty ?? ""}</td>
            <td class="px-2 py-1 text-right">${line.priceKwd ? formatNumber(line.priceKwd,3) : ""}</td>
            <td class="px-2 py-1 text-right">${line.fxPrice != null ? formatNumber(line.fxPrice,2) : ""}</td>
            <td class="px-2 py-1 text-right">${line.totalKwd ? formatNumber(line.totalKwd,3) : ""}</td>
          </tr>`;
        });
        html += `</tbody></table>`;
        addRow("Items", html, true);
      } else {
        addRow("Item (legacy)", po.itemDesc || "");
      }

      addRow("Total Amount (KWD)", formatNumber(po.totalKwd,3));
      addRow(
        "Conversion Rate (" + (po.fxCurrency || "AED/USD") + " per 1 KWD)",
        po.fxRate ? formatNumber(po.fxRate,4) : ""
      );
      addRow(
        "Total Amount (" + (po.fxCurrency || "AED/USD") + ")",
        po.totalFx ? formatNumber(po.totalFx,2) : ""
      );
      addRow("Goods Arrived in Kuwait", po.grnDate);

      let docsHtml = "";
      if (po.invoiceFileDataUrl && po.invoiceFileName) {
        docsHtml += `<a href="${po.invoiceFileDataUrl}" download="${po.invoiceFileName}" class="text-sky-600 underline mr-2">Invoice</a>`;
      }
      if (po.doFileDataUrl && po.doFileName) {
        docsHtml += `<a href="${po.doFileDataUrl}" download="${po.doFileName}" class="text-sky-600 underline mr-2">Delivery Note</a>`;
      }
      if (po.ttFileDataUrl && po.ttFileName) {
        docsHtml += `<a href="${po.ttFileDataUrl}" download="${po.ttFileName}" class="text-sky-600 underline mr-2">TT Copy</a>`;
      }
      if (!docsHtml) docsHtml = "<span class='text-slate-400'>No documents stored</span>";
      addRow("Documents", docsHtml, true);

      detailModal.classList.remove("hidden");
    }

    function closeDetailModal() {
      detailModal.classList.add("hidden");
    }

    function renderMonthlyChart() {
      if (!monthlyChartCanvas) return;
      const yearFilter = filterYear.value;
      const filteredForYear = poData.filter((po)=>{
        const y = getYearFromDateStr(po.poDate);
        if (!y) return false;
        if (yearFilter !== "all" && y !== Number(yearFilter)) return false;
        return true;
      });

      const labels = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const monthlyKwd = new Array(12).fill(0);
      const monthlyFx = new Array(12).fill(0);

      filteredForYear.forEach((po)=>{
        const m = getMonthFromDateStr(po.poDate);
        if (!m) return;
        const idx = m - 1;
        monthlyKwd[idx] += Number(po.totalKwd || 0);
        monthlyFx[idx] += Number(po.totalFx || 0);
      });

      if (monthlyChartInstance) monthlyChartInstance.destroy();

      monthlyChartInstance = new Chart(monthlyChartCanvas.getContext("2d"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "Total KWD", data: monthlyKwd },
            { label: "Total FX", data: monthlyFx },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true } },
          plugins: { legend: { position: "bottom" } },
        },
      });
    }

    poForm.addEventListener("submit", async (e)=>{
      e.preventDefault();

      const supplierVal = (supplierSelect.value || "").trim();
      const invoiceNo = (invoiceNumberInput.value || "").trim();

      if (!poDate.value || !supplierVal || !invoiceNo) {
        alert("Please fill Purchase Date, Invoice Number and Supplier.");
        return;
      }

      const items = [];
      itemsBody.querySelectorAll("tr").forEach((tr)=>{
        const name = (tr.querySelector(".item-name").value || "").trim();
        const qtyVal = Number(tr.querySelector(".item-qty").value) || 0;
        const priceVal = Number(tr.querySelector(".item-price").value) || 0;
        const fxPriceValRaw = tr.querySelector(".item-fxprice").value;
        const fxPriceVal = fxPriceValRaw === "" ? null : Number(fxPriceValRaw);
        const lineTotal = qtyVal * priceVal;
        if (!name && !qtyVal && !priceVal && (fxPriceVal === null)) return;
        if (!name) return;
        items.push({
          name,
          qty: qtyVal || null,
          priceKwd: priceVal || null,
          fxPrice: fxPriceVal,
          totalKwd: lineTotal || null,
        });
      });

      if (!items.length) {
        alert("Please add at least one item row with name and quantity.");
        return;
      }

      const totalKwdVal = Number(totalKwd.value) || 0;
      const totalFxVal = Number(totalFx.value) || 0;

      const [invData, doData, ttData] = await Promise.all([
        readFileAsDataUrl(invoiceFile.files[0]),
        readFileAsDataUrl(doFile.files[0]),
        readFileAsDataUrl(ttFile.files[0]),
      ]);

      const po = {
        id: "PO_" + Date.now(),
        poDate: poDate.value,
        invoiceNumber: invoiceNo,
        supplierName: supplierVal,
        items,
        totalKwd: totalKwdVal || null,
        fxCurrency: fxCurrencyInput.value || null,
        fxRate: fxRate.value || null,
        totalFx: totalFxVal || null,
        invoiceFileName: invoiceFile.files[0]?.name || null,
        invoiceFileDataUrl: invData,
        doFileName: doFile.files[0]?.name || null,
        doFileDataUrl: doData,
        ttFileName: ttFile.files[0]?.name || null,
        ttFileDataUrl: ttData,
        grnDate: grnDate.value || null,
        createdAt: new Date().toISOString(),
      };

      poData.push(po);
      savePOs(poData);

      if (supplierVal && !supplierData.includes(supplierVal)) {
        supplierData.push(supplierVal);
        saveSuppliers(supplierData);
        renderSupplierOptions();
      }
      items.forEach((line)=>{
        if (line.name && !itemData.includes(line.name)) {
          itemData.push(line.name);
        }
      });
      saveItems(itemData);
      populateAllItemSelects();

      refreshYearFilterOptions();
      renderTable();

      // After save: reset form and create ONE blank row
      poForm.reset();
      itemsBody.innerHTML = "";
      addItemRow();
      const today = new Date().toISOString().slice(0,10);
      poDate.value = today;
      fxCurrencyInput.value = "AED";
      updateCurrencyToggleUI("AED");
      recalcTotals();

      alert("Purchase order saved successfully.");
    });

    resetFormBtn.addEventListener("click", ()=>{
      poForm.reset();
      itemsBody.innerHTML = "";
      // On reset: ONE row
      addItemRow();
      const today = new Date().toISOString().slice(0,10);
      poDate.value = today;
      fxCurrencyInput.value = "AED";
      updateCurrencyToggleUI("AED");
      totalKwd.value = "";
      totalFx.value = "";
    });

    filterYear.addEventListener("change", renderTable);
    filterMonth.addEventListener("change", renderTable);
    filterDateExact.addEventListener("change", renderTable);
    filterDocsOnly.addEventListener("change", renderTable);

    clearFiltersBtn.addEventListener("click", ()=>{
      filterYear.value = "all";
      filterMonth.value = "all";
      filterDateExact.value = "";
      filterDocsOnly.checked = false;
      renderTable();
    });

    printBtn.addEventListener("click", ()=>window.print());
    closeModalBtn.addEventListener("click", closeDetailModal);
    detailModal.addEventListener("click", (e)=>{ if (e.target===detailModal) closeDetailModal(); });

    addSupplierBtn.addEventListener("click", ()=>{
      const name = prompt("Enter new supplier name:");
      if (!name) return;
      const trimmed = name.trim();
      if (!trimmed) return;
      if (!supplierData.includes(trimmed)) {
        supplierData.push(trimmed);
        saveSuppliers(supplierData);
        renderSupplierOptions();
      }
      supplierSelect.value = trimmed;
    });

    editSupplierBtn.addEventListener("click", ()=>{
      const current = supplierSelect.value;
      if (!current) {
        alert("Please select a supplier to edit.");
        return;
      }
      const updated = prompt("Edit supplier name:", current);
      if (!updated) return;
      const trimmed = updated.trim();
      if (!trimmed) return;

      const idx = supplierData.indexOf(current);
      if (idx !== -1) supplierData[idx] = trimmed;
      else if (!supplierData.includes(trimmed)) supplierData.push(trimmed);
      saveSuppliers(supplierData);
      renderSupplierOptions();
      supplierSelect.value = trimmed;

      poData.forEach((po)=>{
        if (po.supplierName === current) po.supplierName = trimmed;
      });
      savePOs(poData);
      renderTable();
    });

    addItemMasterBtn.addEventListener("click", ()=>{
      const name = prompt("Enter new item name:");
      if (!name) return;
      const trimmed = name.trim();
      if (!trimmed) return;
      if (!itemData.includes(trimmed)) {
        itemData.push(trimmed);
        saveItems(itemData);
        populateAllItemSelects();
      }
    });

    editItemMasterBtn.addEventListener("click", ()=>{
      if (!itemData.length) {
        alert("No items in master list yet.");
        return;
      }
      const listStr = itemData.join("\n");
      const current = prompt("Type EXACT item name to rename:\n\n" + listStr);
      if (!current) return;
      if (!itemData.includes(current)) {
        alert("Item not found in master list.");
        return;
      }
      const updated = prompt("New name for item:", current);
      if (!updated) return;
      const trimmed = updated.trim();
      if (!trimmed) return;

      const idx = itemData.indexOf(current);
      if (idx !== -1) itemData[idx] = trimmed;
      saveItems(itemData);

      poData.forEach((po)=>{
        if (po.items && po.items.length) {
          po.items.forEach((line)=>{
            if (line.name === current) line.name = trimmed;
          });
        } else if (po.itemDesc === current) {
          po.itemDesc = trimmed;
        }
      });
      savePOs(poData);

      populateAllItemSelects();
      renderTable();
      alert("Item renamed in master list and existing records.");
    });

    addRowBtn.addEventListener("click", ()=>addItemRow());

    fxRate.addEventListener("input", recalcTotals);

    function updateCurrencyToggleUI(selected) {
      document.querySelectorAll("[data-currency-toggle]").forEach((btn)=>{
        if (btn.getAttribute("data-currency-toggle") === selected) {
          btn.classList.add("bg-white","shadow","text-slate-900");
          btn.classList.remove("text-slate-500");
        } else {
          btn.classList.remove("bg-white","shadow","text-slate-900");
          btn.classList.add("text-slate-500");
        }
      });
    }

    document.querySelectorAll("[data-currency-toggle]").forEach((btn)=>{
      btn.addEventListener("click", ()=>{
        const cur = btn.getAttribute("data-currency-toggle");
        fxCurrencyInput.value = cur;
        updateCurrencyToggleUI(cur);
        recalcTotals();
      });
    });

    (function init(){
      poData = loadPOs();
      supplierData = loadSuppliers();
      itemData = loadItems();

      if (!supplierData.length && poData.length) {
        supplierData = Array.from(new Set(poData.map(p=>p.supplierName).filter(x=>x && x.trim()!=="")));
        saveSuppliers(supplierData);
      }

      if (!itemData.length && poData.length) {
        const legacyItems = [];
        poData.forEach((p)=>{
          if (p.items && p.items.length) {
            p.items.forEach(l=>{ if (l.name) legacyItems.push(l.name); });
          } else if (p.itemDesc) {
            legacyItems.push(p.itemDesc);
          }
        });
        itemData = Array.from(new Set(legacyItems));
        saveItems(itemData);
      }

      renderSupplierOptions();
      refreshYearFilterOptions();
      renderTable();

      // On first load: ONE default row
      itemsBody.innerHTML = "";
      addItemRow();

      const today = new Date().toISOString().slice(0,10);
      poDate.value = today;

      fxCurrencyInput.value = "AED";
      updateCurrencyToggleUI("AED");
    })();
  </script>
</body>
</html>
